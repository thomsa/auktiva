# .github/workflows/vercel-release.yml
name: Vercel Production Deploy on Tag

on:
  push:
    tags:
      - "v*" # e.g. v1.0.0, v1.0.1, etc.

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.check-docs.outputs.docs_changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # So we can check what commit the tag points to
          fetch-depth: 0

      - name: Ensure tag is on main
        run: |
          TAG_COMMIT=$(git rev-list -n 1 $GITHUB_REF)
          MAIN_COMMIT=$(git rev-parse origin/main)

          if ! git branch --contains "$TAG_COMMIT" | grep -q "main"; then
            echo "Tag is not on main. Skipping deploy."
            exit 0
          fi

      - name: Trigger Vercel Deploy Hook
        run: |
          curl -X POST "$VERCEL_DEPLOY_HOOK_URL"
        env:
          VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}

      - name: Check for docs changes
        id: check-docs
        run: |
          # Get the previous tag
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -A1 "^${CURRENT_TAG}$" | tail -1)

          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ]; then
            # No previous tag found, check against first commit
            echo "No previous tag found, assuming docs changed"
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Comparing $PREVIOUS_TAG to $CURRENT_TAG"

          # Check if any files in /docs have changed between tags
          DOCS_CHANGES=$(git diff --name-only "$PREVIOUS_TAG" "$CURRENT_TAG" -- docs/ | wc -l)

          if [ "$DOCS_CHANGES" -gt 0 ]; then
            echo "Found $DOCS_CHANGES changed files in docs/"
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes in docs/"
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi

  deploy-docs:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.docs_changed == 'true'

    steps:
      - name: Trigger Vercel Docs Deploy Hook
        run: |
          echo "Deploying docs..."
          curl -X POST "$VERCEL_DOCS_DEPLOY_HOOK_URL"
        env:
          VERCEL_DOCS_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DOCS_DEPLOY_HOOK_URL }}
